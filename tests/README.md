Singletons testsuite notes
==========================

Singletons testsuite is built using
[tasty](http://hackage.haskell.org/package/tasty) testing framework. Aside from
standard HUnit and QuickCheck tests it contains a number of compile-and-dump
tests. These tests run GHC to compile a test file that uses singletons library
and compare the generated Template Haskell splices against expected output
saved in a "golden" file. Below are some details about these tests:

 * GHC uses the in-tree singletons library. This means there is no need to
   install the library in your system before running the tests. You can simply
   run the tests with:

      ```bash
      make tests
      ```

 * Compile-and-dump tests are stored in subdirectories of
   `tests/compile-and-dump/` directory. Files with `.template` extension store
   expected output and are used to generate the actual `.golden` files. (see
   section "Generating golden files from templates" below). Running the
   testsuite produces files with `.actual` extension which contain actual output
   produced by GHC. These files are not deleted by the testsuite, which allows
   to inspect them in case the test fails. To remove the `.actual` and `.golden`
   files run:

      ```bash
      make clean-tests
      ```

 * Running the testsuite requires `awk`, `sed` and `diff`. `awk` is used to
   generate golden files from templates (see below). `sed` is used to normalize
   output from GHC (see Note [Normalization with sed]).`diff` is used to compare
   golden and actual files.

 * Each compile-and-dump test requires a set of GHC options to be used for
   compilation. Testsuite defines a default set of options that enable on the
   command line all the extensions required by singletons. This makes writing
   tests easier since there is no need to put all the extensions into a source
   file. The default options also enable `-ddump-splices` (dumps splices
   generated by Template Haskell), `-dsuppress-uniques` (avoids test failures
   due to unique identifiers), `-v0` (silences GHC) and `-fforce-recomp` (forces
   recompilation each time a testsuite is run). There is a convenience function
   that creates a test with standard GHC options defined by the testsuite.

 * Testsuite supports multiple GHC versions because each version produces
   different Template Haskell output. Every test requires a separate golden
   file. GHC HEAD is currently not supported. Golden files for GHC 8.2 have
   `.ghc82` appended before their extension.

 * You can run single tests or groups of tests whose name match a regexp using
   tasty's pattern feature. For example:

   ```bash
   cabal test --test-options="--pattern=Testsuite/Singletons/*"
   ```

   runs all tests in the Testsuite/Singletons branch of the test tree.
   SingletonsTestSuite module defines structure of the test tree.

## Generating golden files from templates

It is possible to have definitions generated in one tests used in another
test. A good example of this is `SingletonsNat` test which singletonizes
definition of `Nat` datatype. `SingletonsNat` is imported from other tests to
reuse the generated `Nat` definitions. Due to `-fforce-recomp` option
`SingletonsNat` module will be recompiled for every test and therefore splices
generated during its compilation will be included in the output of every test
that imports `SingletonsNat`. One way to deal with the problem would be to
prepare golden files that include all generated splices, including those from
imported modules. The problem with this approach is that if we have 100 tests
that include `SingletonsNat` and change the way singletons are generated we will
have to update 100 files with exected output. This problem is solved with
templates. Template file contains expected output but it may also include
`INSERT tests/compile-and-dump/Foo.XXXX.template` pragma, which inserts the
contents of a specified template file (XXXX represents GHC version).

This feature is recursive but can be a bit tricky. See `Singletons/EqInstances`
test for example.

## ByHand files

`tests` directory contains `ByHand.hs` and `ByHandAux.hs` files. They are
intended as a sandbox where all the definitions generated by singletons are
written by hand. These files don't test correctness of singletons library and
are thus not part of the testsuite. You can compile these files with:

  ```bash
  make byhand
  ```
